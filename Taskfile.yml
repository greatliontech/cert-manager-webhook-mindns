# yaml-language-server: $schema=https://taskfile.dev/schema.json

version: "3"

vars:
  BINARY_NAME: webhook
  IMAGE_NAME: cert-manager-webhook-mindns
  IMAGE_REGISTRY: ghcr.io/greatliontech
  CHART_PATH: deploy/mindns-webhook

tasks:
  default:
    desc: Help (this message)
    cmds:
      - task -l
    silent: true

  build:
    desc: Build the binary
    cmds:
      - go build -o {{.BINARY_NAME}} .
    silent: true

  test:
    desc: Run conformance tests
    deps: [fetch-test-binaries]
    cmds:
      - |
        CONFORMANCE_TEST=1 \
        TEST_ASSET_ETCD=_test/kubebuilder/etcd \
        TEST_ASSET_KUBE_APISERVER=_test/kubebuilder/kube-apiserver \
        TEST_ASSET_KUBECTL=_test/kubebuilder/kubectl \
        go test -v ./...
    silent: true

  fetch-test-binaries:
    desc: Download kubebuilder test binaries
    vars:
      KUBEBUILDER_VERSION: "1.28.0"
      OS:
        sh: go env GOOS
      ARCH:
        sh: go env GOARCH
    cmds:
      - mkdir -p _test/kubebuilder
      - |
        if [ ! -f _test/kubebuilder/etcd ]; then
          curl -fsSL https://go.kubebuilder.io/test-tools/{{.KUBEBUILDER_VERSION}}/{{.OS}}/{{.ARCH}} -o _test/kubebuilder.tar.gz
          tar xfO _test/kubebuilder.tar.gz kubebuilder/bin/etcd > _test/kubebuilder/etcd && chmod +x _test/kubebuilder/etcd
          tar xfO _test/kubebuilder.tar.gz kubebuilder/bin/kube-apiserver > _test/kubebuilder/kube-apiserver && chmod +x _test/kubebuilder/kube-apiserver
          tar xfO _test/kubebuilder.tar.gz kubebuilder/bin/kubectl > _test/kubebuilder/kubectl && chmod +x _test/kubebuilder/kubectl
          rm _test/kubebuilder.tar.gz
        fi
    status:
      - test -f _test/kubebuilder/etcd
    silent: true

  lint:
    desc: Run golangci-lint
    cmds:
      - golangci-lint run
    silent: true

  tidy:
    desc: Run go mod tidy
    cmds:
      - go mod tidy
    silent: true

  docker-build:
    desc: Build Docker image
    vars:
      TAG: '{{.TAG | default "latest"}}'
    cmds:
      - docker build -t {{.IMAGE_REGISTRY}}/{{.IMAGE_NAME}}:{{.TAG}} .
    silent: true

  docker-push:
    desc: Push Docker image
    vars:
      TAG: '{{.TAG | default "latest"}}'
    cmds:
      - docker push {{.IMAGE_REGISTRY}}/{{.IMAGE_NAME}}:{{.TAG}}
    silent: true

  helm-lint:
    desc: Lint Helm chart
    cmds:
      - helm lint {{.CHART_PATH}}
    silent: true

  helm-template:
    desc: Render Helm chart templates
    cmds:
      - helm template {{.CHART_PATH}}
    silent: true

  clean:
    desc: Clean build artifacts
    cmds:
      - rm -f {{.BINARY_NAME}}
    silent: true
